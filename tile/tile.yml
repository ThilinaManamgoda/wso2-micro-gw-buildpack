---
name: wso2am-micro-gateway-buildpack
icon_file: resources/wso2-logo.png
label: WSO2 API Micro-gateway Buildpack
description: WSO2 API Micro-gateway Buildpack

stemcell_criteria:
  os: ubuntu-xenial
  requires_cpi: false
  version: '170.15'

forms:
  - name: buildpack_order
    label: Buildpack order
    description: Buildpack order
    properties:
      - name: buildpack_order
        type: integer
        label: Buildpack order
        default: 99
  - name: trusted_certs
    label: Trusted certificates
    description: Trusted certificates
    properties:
      - name: jwt_cert
        label: Certificate for JWT token signature verification
        type: ca_certificate
        configurable: true
      - name: certs
        label: Trusted CA certificates for http client
        type: ca_certificate
        configurable: true
  - name: analytics_configurations
    label: Analytics configurations
    description: Analytics configurations
    properties:
      - name: enable_analytics
        type: boolean
        label: Enable Analytics
        default: false
      - name: uploading_endpoint
        type: http_url
        label: Uploading endpoint
        default: "https://localhost:9444/analytics/v1.0/usage/upload-file"
      - name: uploading_time_span_in_millis
        type: integer
        label: Uploading timeSpan in Millis
        default: 600000
      - name: rotating_period
        type: integer
        label: Rotating period
        default: 600000
      - name: task_upload_files
        type: boolean
        label: Task uploadFiles
        default: true
      - name: analytics_creds
        type: simple_credentials
        label: Analytics credentails
  - name: key_manager_configurations
    label: Key Manager configurations
    description: Key Manager configurations
    properties:
      - name: keymanager_server_url
        type: http_url
        label: Server URL
        default: "https://localhost:9443"
      - name: keymanager_creds
        type: simple_credentials
        label: Key Manager credentails
      - name: token_context
        type: string
        label: Token context
        default: "oauth2"
      - name: timestamp_skew
        type: integer
        label: Timestamp skew
        default: 5000
  - name: throttling_configurations
    label: Global throttling configurations
    description: Global throttling configurations
    properties:
      - name: enable_throttling
        type: boolean
        label: Enable Global throttling
        default: false
      - name: jms_connection_initial_context_factory
        type: string
        label: JMS connection initial context factory
        default: "bmbInitialContextFactory"
      - name: jms_connection_provider_url
        type: string
        label: JMS connection provider URL
        default: "amqp://admin:admin@carbon/carbon?brokerlist='tcp://localhost:5672'"
      - name: jms_connection_creds
        type: simple_credentials
        label: JMS connection credentials
      - name: throttle_endpoint_url
        type: http_url
        label: Throttling endpoint URL
        default: "https://localhost:9443/endpoints"
      - name: throttle_endpoint_base64_header_creds
        type: simple_credentials
        label: Throttling endpoint base 64 header
packages:
  - name: wso2am_micro_gateway_buildpack
    type: bosh-release
    path: bosh-release/wso2am-micro-gw-3.0.0-buildpack-release.tgz
    jobs:
    - name: buildpack-deploy
      templates:
        - name: buildpack-deploy
          release: wso2am-micro-gw-3.0.0-buildpack-release
      lifecycle: errand
      post_deploy: true
      memory: 512
      ephemeral_disk: 4096
      persistent_disk: 0
      cpu: 2
      dynamic_ip: 1
      properties:
        certs: (( .properties.certs.value ))
        jwt_cert: (( .properties.jwt_cert.value ))
        buildpack_order: (( .properties.buildpack_order.value ))
        analytics:
          enable: (( .properties.enable_analytics.value ))
          uploading_endpoint: (( .properties.uploading_endpoint.value ))
          uploading_time_span_in_millis: (( .properties.uploading_time_span_in_millis.value ))
          rotating_period: (( .properties.rotating_period.value ))
          task_uploadFiles: (( .properties.task_upload_files.value ))
          username: (( .properties.analytics_creds.identity ))
          password: (( .properties.analytics_creds.password ))
        keymanager:
          server_url: (( .properties.keymanager_server_url.value ))
          username: (( .properties.keymanager_creds.identity ))
          password: (( .properties.keymanager_creds.password ))
          token_context: (( .properties.token_context.value ))
          timestamp_skew: (( .properties.timestamp_skew.value ))
        throttling:
          enable: (( .properties.enable_throttling.value ))
          jms_connection_initial_context_factory: (( .properties.jms_connection_initial_context_factory.value ))
          jms_connection_provider_url: (( .properties.jms_connection_provider_url.value ))
          jms_connection_username: (( .properties.jms_connection_creds.identity ))
          jms_connection_password: (( .properties.jms_connection_creds.password ))
          throttle_endpoint_url: (( .properties.throttle_endpoint_url.value ))
          throttle_endpoint_base64_header_username: (( .properties.throttle_endpoint_base64_header_creds.identity ))
          throttle_endpoint_base64_header_password: (( .properties.throttle_endpoint_base64_header_creds.password ))
    - name: buildpack-delete
      templates:
        - name: buildpack-delete
          release: wso2am-micro-gw-3.0.0-buildpack-release
      lifecycle: errand
      pre_delete: true
      memory: 512
      ephemeral_disk: 4096
      persistent_disk: 0
      cpu: 2
      dynamic_ip: 1
